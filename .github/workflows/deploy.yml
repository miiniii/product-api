name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64
          tags: miiniiiiii/product-api:latest

  deploy-ec2-1:
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Set up SSH for EC2 #1
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY_1 }}

      - name: Deploy to EC2 #1
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST_1 }} << EOF
            docker rm -f product-api || true
            docker pull miiniiiiii/product-api:latest
            docker run -d --name product-api -p 8080:8080 \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e SPRING_DATASOURCE_URL="${{ secrets.SPRING_DATASOURCE_URL }}" \
              -e SPRING_DATASOURCE_USERNAME="${{ secrets.SPRING_DATASOURCE_USERNAME }}" \
              -e SPRING_DATASOURCE_PASSWORD="${{ secrets.SPRING_DATASOURCE_PASSWORD }}" \
              -e SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}" \
              miiniiiiii/product-api:latest
          EOF

  deploy-ec2-2:
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Set up SSH for EC2 #2
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY_2 }}

      - name: Deploy to EC2 #2 (product-api-2)
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST_2 }} << 'EOF'
          IMAGE_NAME=miiniiiiii/product-api:latest
          CONTAINER_NAME=product-api-2
          PORT_MAPPING="-p 8081:8080"

          if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
            PID=$(docker inspect --format '{{.State.Pid}}' ${CONTAINER_NAME} 2>/dev/null || echo "")
            if [ -n "$PID" ] && [ "$PID" -gt 0 ]; then
              sudo kill -9 $PID || true
            fi
            docker rm -f $CONTAINER_NAME || sudo systemctl restart docker
          fi

          docker pull $IMAGE_NAME

          docker run -d --name $CONTAINER_NAME $PORT_MAPPING \
            -e SPRING_PROFILES_ACTIVE=prod \
            -e SPRING_DATASOURCE_URL="${{ secrets.SPRING_DATASOURCE_URL }}" \
            -e SPRING_DATASOURCE_USERNAME="${{ secrets.SPRING_DATASOURCE_USERNAME }}" \
            -e SPRING_DATASOURCE_PASSWORD="${{ secrets.SPRING_DATASOURCE_PASSWORD }}" \
            -e SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}" \
            $IMAGE_NAME
          EOF

  deploy-ec2-3:
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Set up SSH for EC2 #3
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY_3 }}

      - name: Deploy to EC2 #3 (product-api-3)
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST_3 }} << 'EOF'
          IMAGE_NAME=miiniiiiii/product-api:latest
          CONTAINER_NAME=product-api-3
          PORT_MAPPING="-p 8082:8080"

          if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
            PID=$(docker inspect --format '{{.State.Pid}}' ${CONTAINER_NAME} 2>/dev/null || echo "")
            if [ -n "$PID" ] && [ "$PID" -gt 0 ]; then
              sudo kill -9 $PID || true
            fi
            docker rm -f $CONTAINER_NAME || sudo systemctl restart docker
          fi

          docker pull $IMAGE_NAME

          docker run -d --name $CONTAINER_NAME $PORT_MAPPING \
            -e SPRING_PROFILES_ACTIVE=prod \
            -e SPRING_DATASOURCE_URL="${{ secrets.SPRING_DATASOURCE_URL }}" \
            -e SPRING_DATASOURCE_USERNAME="${{ secrets.SPRING_DATASOURCE_USERNAME }}" \
            -e SPRING_DATASOURCE_PASSWORD="${{ secrets.SPRING_DATASOURCE_PASSWORD }}" \
            -e SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}" \
            $IMAGE_NAME
          EOF

